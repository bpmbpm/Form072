<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mermaid: Модульная система</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Построение схемы Mermaid</h1>
    <div id="fileInputContainer">
        <p>Выберите файл (если inData = "File"):</p>
        <input type="file" id="fileInput" accept=".txt">
    </div>
    <div id="output"></div>
    <div id="mermaidCode" class="code-block" style="display:none;"></div>
    <div id="mermaidUrl" class="url-block" style="display:none;"></div>

    <script>
// Конфигурация внутри js:    
        const CONFIG = {
            Settings: {
                inData: 'DataSet',            // 'File' или 'DataSet'. File - предложить открыть файл, а DataSet - брать из перенной DataSetRef: 'DATASET_072',
                outData: 'mermaid.live',   // 'mermaid.live' или 'text'
                DataSetRef: 'DATASET_072v3',// имя глобальной переменной с данными
                sysSourceTarget: 'no'      // показывать источники_8 и получатели_9 данных: yes - показывать (show) , иное не показывать
            }
        };    

        // https://github.com/bpmbpm/doc/blob/main/IT/reliability_risk/risk/850P/f072/server.md
        // microsoft|21H2|Не применимо|  Разработчик13 - модификация14 - Класс оборудования15 т.е. Если 15 = Не применимо, то это ПО, иначе Оборудование
        // Глобальная переменная с данными
// ver 1: ТпрКО6 (открытие и ведение счетов ФЛ) = АБС
        window.DATASET_072v1 = [
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Прикладное ПО: ЦФТ-Банк Платформы 2MCA DBI|Прин1|Ри2|АО ЦФТ|2.9.3|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Сервер приложений: Apache Tomcat|Прин1|Ри2|Apache Software Foundation|9.0.85|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Среда исполнения: Oracle JDK |Прин1|Ри2|Oracle Inc.|17.0.11|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Системное ПО, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Оборудование, сервер: Aquarius C86 |Прин1|Ри2|ГК «Аквариус»|T1F S28H|Клсо1|Клс99|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Прикладное ПО, СУБД: Postgres Pro Enterprise|Прин1|Ри2|ООО «Постгрес Про»|15.6.1|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Системное ПО, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Оборудование сервера: Aquarius C86 |Прин1|Ри2|ГК «Аквариус»|T1F D88|Клсо1|Клс99|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
        ];
// ver 2: ТпрКО6 = АБС + CRM 
        window.DATASET_072v2 = [
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM|Не применимо|Прикладное ПО: ЦФТ-Банк Платформы 2MCA DBI|Прин1|Ри2|АО ЦФТ|2.9.3|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM|Не применимо|Сервер приложений: Apache Tomcat|Прин1|Ри2|Apache Software Foundation|9.0.85|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM|Не применимо|Среда исполнения: Oracle JDK |Прин1|Ри2|Oracle Inc.|17.0.11|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM|Не применимо|Системное ПО, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM|Не применимо|Оборудование, сервер: Aquarius C86 |Прин1|Ри2|ГК «Аквариус»|T1F S28H|Клсо1|Клс99|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM|Не применимо|СУБД: Postgres Pro Enterprise|Прин1|Ри2|ООО «Постгрес Про»|15.6.1|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM|Не применимо|Системное ПО, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM|Не применимо|Оборудование сервера: Aquarius C86 |Прин1|Ри2|ГК «Аквариус»|T1F D88|Клсо1|Клс99|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС1 ЦФТ|Прикладное ПО: Creatio|Прин1|Ри2|Creatio / Terrasoft|8.0.9|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС1 ЦФТ|Среда исполнения: .NET|Прин1|Ри2|Microsoft|8.0.6|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС1 ЦФТ|Веб-сервер: Internet Information Services, IIS|Прин1|Ри2|Microsoft|10.0|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС1 ЦФТ|Системное ПО, ОС: Microsoft Windows Server 2022|Прин1|Ри2|Microsoft|Standard|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС1 ЦФТ|Оборудование сервера: Dell PowerEdge|Прин1|Ри2|Dell Inc.|R760|Клсо1|Клс99|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС1 ЦФТ|СУБД: Microsoft SQL Server 2022|Прин1|Ри2|Microsoft|Enterprise Edition|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС1 ЦФТ|Системное ПО, ОС: Microsoft Windows Server 2022|Прин1|Ри2|Microsoft|Datacenter|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС1 ЦФТ|Оборудование сервера: Dell PowerEdge|Прин1|Ри2|Dell Inc.|R760xd|Клсо1|Клс99|840|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
        ];  

// ver 3 ТпрКО6 = АБС + CRM ФЛ & кредитный конвейер ЮЛ
        window.DATASET_072v3 = [
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Прикладное ПО: ЦФТ-Банк Платформы 2MCA DBI|Прин1|Ри2|АО ЦФТ|2.9.3|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Сервер приложений: Apache Tomcat|Прин1|Ри2|Apache Software Foundation|9.0.85|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Среда исполнения: Oracle JDK |Прин1|Ри2|Oracle Inc.|17.0.11|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Системное ПО, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Оборудование, сервер: Aquarius C86 |Прин1|Ри2|ГК «Аквариус»|T1F S28H|Клсо1|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|СУБД: Postgres Pro Enterprise|Прин1|Ри2|ООО «Постгрес Про»|15.6.1|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Системное ПО, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Оборудование сервера: Aquarius C86 |Прин1|Ри2|ГК «Аквариус»|T1F D88|Клсо1|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM ФЛ|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ|Прикладное ПО: Creatio|Прин1|Ри2|Creatio / Terrasoft|8.0.9|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM ФЛ|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ|Среда исполнения: .NET|Прин1|Ри2|Microsoft|8.0.6|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM ФЛ|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ|Веб-сервер: Internet Information Services, IIS|Прин1|Ри2|Microsoft|10.0|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM ФЛ|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ|Системное ПО, ОС: Microsoft Windows Server 2022|Прин1|Ри2|Microsoft|Standard|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM ФЛ|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ|Оборудование сервера: Dell PowerEdge|Прин1|Ри2|Dell Inc.|R760|Клсо1|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM ФЛ|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ|СУБД: Microsoft SQL Server 2022|Прин1|Ри2|Microsoft|Enterprise Edition|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM ФЛ|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ|Системное ПО, ОС: Microsoft Windows Server 2022|Прин1|Ри2|Microsoft|Datacenter|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО6|CRM ФЛ|ОУ|БфКО22|CRM ФЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ|Оборудование сервера: Dell PowerEdge|Прин1|Ри2|Dell Inc.|R760xd|Клсо1|Клс1|840|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|CRM ЮЛ|ОУ|БфКО22|CRM ЮЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ-Кредиты ЮЛ|Прикладное ПО: Creatio|Прин1|Ри2|Creatio / Terrasoft|8.0.9|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|CRM ЮЛ|ОУ|БфКО22|CRM ЮЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ-Кредиты ЮЛ|Среда исполнения: .NET|Прин1|Ри2|Microsoft|8.0.6|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|CRM ЮЛ|ОУ|БфКО22|CRM ЮЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ-Кредиты ЮЛ|Веб-сервер: Internet Information Services, IIS|Прин1|Ри2|Microsoft|10.0|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|CRM ЮЛ|ОУ|БфКО22|CRM ЮЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ-Кредиты ЮЛ|Системное ПО, ОС: Microsoft Windows Server 2022|Прин1|Ри2|Microsoft|Standard|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|CRM ЮЛ|ОУ|БфКО22|CRM ЮЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ-Кредиты ЮЛ|Оборудование сервера: Dell PowerEdge|Прин1|Ри2|Dell Inc.|R760|Клсо1|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|CRM ЮЛ|ОУ|БфКО22|CRM ЮЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ-Кредиты ЮЛ|СУБД: Microsoft SQL Server 2022|Прин1|Ри2|Microsoft|Enterprise Edition|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|CRM ЮЛ|ОУ|БфКО22|CRM ЮЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ-Кредиты ЮЛ|Системное ПО, ОС: Microsoft Windows Server 2022|Прин1|Ри2|Microsoft|Datacenter|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|CRM ЮЛ|ОУ|БфКО22|CRM ЮЛ банка|Creatio / Terrasoft|Урв1|Не применимо|АБС ЦФТ-Кредиты ЮЛ|Оборудование сервера: Dell PowerEdge|Прин1|Ри2|Dell Inc.|R760xd|Клсо1|Клс1|840|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|Кредиты ЮЛ|ОУ|БфКО22|Кредитный конвейер ЮЛ банка|Интегратор 1|Урв1|АБС ЦФТ|АБС ЦФТ|Прикладное ПО: ELMA BPM Suite Enterprise|Прин1|Ри2|ELMA|4.2.10.55|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|Кредиты ЮЛ|ОУ|БфКО22|Кредитный конвейер ЮЛ банка|Интегратор 1|Урв1|АБС ЦФТ|АБС ЦФТ|Среда исполнения: .NET Core Runtime|Прин1|Ри2|Microsoft|8.0.6|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|Кредиты ЮЛ|ОУ|БфКО22|Кредитный конвейер ЮЛ банка|Интегратор 1|Урв1|АБС ЦФТ|АБС ЦФТ|Веб-сервер: Internet Information Services, IIS|Прин1|Ри2|Microsoft|10.0|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|Кредиты ЮЛ|ОУ|БфКО22|Кредитный конвейер ЮЛ банка|Интегратор 1|Урв1|АБС ЦФТ|АБС ЦФТ|Системное ПО, ОС: Microsoft Windows Server 2022|Прин1|Ри2|Microsoft|Standard|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|Кредиты ЮЛ|ОУ|БфКО22|Кредитный конвейер ЮЛ банка|Интегратор 1|Урв1|АБС ЦФТ|АБС ЦФТ|Оборудование сервера: Dell PowerEdge|Прин1|Ри2|Dell Inc.|R760|Клсо1|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|Кредиты ЮЛ|ОУ|БфКО22|Кредитный конвейер ЮЛ банка|Интегратор 1|Урв1|АБС ЦФТ|АБС ЦФТ|СУБД: Microsoft SQL Server 2022|Прин1|Ри2|Microsoft|Enterprise Edition|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|Кредиты ЮЛ|ОУ|БфКО22|Кредитный конвейер ЮЛ банка|Интегратор 1|Урв1|АБС ЦФТ|АБС ЦФТ|Системное ПО, ОС: Microsoft Windows Server 2022|Прин1|Ри2|Microsoft|Datacenter|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|Кредиты ЮЛ|ОУ|БфКО22|Кредитный конвейер ЮЛ банка|Интегратор 1|Урв1|АБС ЦФТ|АБС ЦФТ|Оборудование сервера: Dell PowerEdge|Прин1|Ри2|Dell Inc.|R760xd|Клсо1|Клс1|840|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Прикладное ПО: ЦФТ-Банк Платформы 2MCA DBI|Прин1|Ри2|АО ЦФТ|2.9.3|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Сервер приложений: Apache Tomcat|Прин1|Ри2|Apache Software Foundation|9.0.85|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Среда исполнения: Oracle JDK |Прин1|Ри2|Oracle Inc.|17.0.11|Клсо99|Клс1|840|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Системное ПО, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Оборудование, сервер: Aquarius C86 |Прин1|Ри2|ГК «Аквариус»|T1F S28H|Клсо1|Клс1|810|Не применимо|Лиц9|Арх3.3|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|СУБД: Postgres Pro Enterprise|Прин1|Ри2|ООО «Постгрес Про»|15.6.1|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Системное ПО, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
            'ТпрКО3|АБС ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|CRM ФЛ-CRM ЮЛ|Кредиты ЮЛ|Оборудование сервера: Aquarius C86 |Прин1|Ри2|ГК «Аквариус»|T1F D88|Клсо1|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',
        ];          
              
// ТпрКО6 - открытие и ведение счетов ФЛ        
//  'ТпрКО9|Lekton Classic|ОУ|БфКО22|Фронт-офисная система учёта с использованием пластиковых карт|lekton|Урв1|АС4|АС2|Windows 10|Прин1|Ри1|microsoft|21H2|Клсо1|Клс1|840|Не применимо|Лиц9|Арх3.1|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|'
//  Вручную уникальность (СУБД):
// 'ТпрКО8|АБС1 ЦФТ|ОУ|БфКО22|Основная АБС банка|АО_ЦФТ|Урв1|АС1|АС2|Системное ПО, СУБД, ОС: Ред ОС Сервер|Прин1|Ри2|ООО «Ред Софт»|10.2|Клсо99|Клс1|810|Не применимо|Лиц9|Арх3.2|Не применимо|Закуп5|Поддерж4|Авт1|Обнв4|Уязв1|Упр1|ФСТЭК9|Не применимо|',

// Ограничения mermaid
// Не указывать ничего в скобках 
// Для отдельных позиций нельзя указывать пробелы, например, первая позиция
// Если строки - повторы, то будут по две линии 
// Кавычки "" заменить на « »

// Start

 (async () => {
            try {
                // Отображаем текущие режимы при старте
                showMessage(`
                    <p style="color:blue;">
                        Текущий режим:<br>
                        • Ввод данных: <strong>${CONFIG.Settings.inData}</strong><br>
                        • Вывод данных: <strong>${CONFIG.Settings.outData}</strong><br>
                        • Вывод систем источников \\ приемников данных: <strong>${CONFIG.Settings.sysSourceTarget}</strong>
                    </p>
                `);

                // Скрываем поле загрузки, если не нужен файл
                if (CONFIG.Settings.inData !== 'File') {
                    document.getElementById('fileInputContainer').style.display = 'none';
                }

                if (CONFIG.Settings.inData === 'File') {
                    // Обработчик выбора файла
                    document.getElementById('fileInput').addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        try {
                            const text = await file.text();
                            const lines = text.split('\n').filter(line => line.trim() !== '');
                            await processOutput(lines);
                        } catch (error) {
                            showMessage(`<p style="color:red;">Ошибка при чтении файла: ${error.message}</p>`);
                        }
                    });
                } else if (CONFIG.Settings.inData === 'DataSet') {
                    // Берём данные из глобальной переменной
                    if (CONFIG.Settings.DataSetRef && window[CONFIG.Settings.DataSetRef]) {
                        const lines = window[CONFIG.Settings.DataSetRef];
                        await processOutput(lines);
                    } else {
                        showMessage(`<p style="color:red;">DataSet не найден: ${CONFIG.Settings.DataSetRef}</p>`);
                    }
                } else {
                    showMessage(`<p style="color:red;">Неизвестный режим inData: ${CONFIG.Settings.inData}</p>`);
                }
            } catch (error) {
                showMessage(`<p style="color:red;">Критическая ошибка: ${error.message}</p>`);
            }
        })();

        // Функция для отображения настроек конфигурации
        function displayConfigSettings() {
            return `
                <p>
                    Считанные настройки из блока  Settings:<br>                
                    Режим ввода данных: <strong>${CONFIG.Settings.inData}</strong><br>
                    Режим вывода данных: <strong>${CONFIG.Settings.outData}</strong><br>
                    Соединение систем источников \\ приемников данных: <strong>${CONFIG.Settings.sysSourceTarget}</strong>
                </p>
            `;
        }

        async function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Не удалось загрузить ${src}`));
                document.head.appendChild(script);
            });
        }

        async function ensurePako() {
            if (window.pako) return;
 //           await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js');
              await loadScript('./pako.min.js');
        }

        function parseLines(lines) {
            let partsys // строка для систем источников \ получателей 
            const mermaidLines = ['graph LR;'];
            let lineNumber = 1;  // нумерация строк начинается с 1
            let soft_hard_id; // Развилка на основе кода 15
            let soft_hard_txt;
            let it_prod_10_id; // ИТ-продукт
            let it_prod_10_txt 
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                const parts = trimmed.split('|');
                parts.unshift(lineNumber)                 
                const tp_1 = parts[1];  // ТП в позиции 1
                let sys_name_2 = parts[2];  // название системы в позиции 2
                let sys_name_2_id = sys_name_2.replace(/ /g, "_");  
                let sys_name_2_txt = sys_name_2 + "<br>" + parts[5] + ", " + parts[6]; 
                
                let arch_level_id =  sys_name_2_id + ":" + parts[20];
//              if (parts[15] == "Не применимо") {
                if (parts[15] == "Клсо99") {                
                    soft_hard_id = arch_level_id + ":" + "software";
                    soft_hard_txt = "software";
                } else {
                    soft_hard_id = arch_level_id + ":" + "hardware";
                    soft_hard_txt = "hardware";
                }
                
                it_prod_10_id =  sys_name_2_id + parts[20] + parts[10].replace(/ /g, "_") + ":" + parts[12];  // 12 - это признак резервной. Также хорошо бы, чтобы оно было уникальным. Можно отслеживать вручную или добавлять parts[20] 
                it_prod_10_txt =  parts[10] + "<br>" + parts[14] + "<br>" + parts[13] + ", " + parts[17]; 
                if (parts[12] == "Ри1") {
                    it_prod_10_txt = it_prod_10_txt + "<br>" + "-Резерв-";  
                }
                
                mermaidLines.push(`${tp_1} --> ${sys_name_2_id}(${sys_name_2_txt}) --> ${arch_level_id}((${parts[20]})) --> ${soft_hard_id}((${soft_hard_txt})) --> ${it_prod_10_id}([${it_prod_10_txt}]) `);
    
//            sysSourceTarget Добавлять связь между АС       
         if (CONFIG.Settings.sysSourceTarget === 'yes') {     

                if (parts[8] != "Не применимо") {
                    for (partsys of parts[8].split('-')) {  // source
//                         mermaidLines.push(`${partsys.replace(/ /g, "_")} --> ${sys_name_2_id}`);
//                        mermaidLines.push(`${partsys.replace(/ /g, "_")} -.-> ${sys_name_2_id}`);
                        mermaidLines.push(`${partsys.replace(/ /g, "_")} -. source .-> ${sys_name_2_id}`);
                    }
                }
                
                if (parts[9] != "Не применимо") {
                    for (partsys of parts[9].split('-')) { // target
//                        mermaidLines.push(`${sys_name_2_id} --> ${partsys.replace(/ /g, "_")}`);
                        mermaidLines.push(`${sys_name_2_id} -. target .-> ${partsys.replace(/ /g, "_")}`);
                    }
                }
         } // if (CONFIG.Settings.inData     
         
                lineNumber++;
            }
            return mermaidLines.join('\n');    
        }

        function showElement(id, content) {
            document.getElementById(id).style.display = 'block';
            document.getElementById(id).textContent = content;
        }

        function showMessage(html) {
            document.getElementById('output').innerHTML = html;
        }


        async function processOutput(lines) {
            const code = parseLines(lines);

            if (CONFIG.Settings.outData === 'text') {
                showElement('mermaidCode', code);
                showMessage(displayConfigSettings());
                return;
            }

            if (CONFIG.Settings.outData === 'mermaid.live') {
                await ensurePako();
                const data = { code, mermaid: { theme: 'default' } };
                const json = JSON.stringify(data);
                const compressed = pako.gzip(json, { level: 9 });

                let binary = '';
                for (let i = 0; i < compressed.length; i++) {
                    binary += String.fromCharCode(compressed[i]);
                }
                const base64 = btoa(binary);
                const url = `https://mermaid.live/view#pako:${base64}`;

                showElement('mermaidUrl', url);
                showMessage(`
                    ${displayConfigSettings()}
                    <p style="color:green;">Ссылка на Mermaid Live (откроется в новой вкладке):</p>
               
                `);

                // Открываем ссылку в новой вкладке
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.click();
            }
        }

        
    </script>
</body>
</html>